version: '3.8'

services:
  # 1. Medusa API (Server)
  medusa-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: medusa_server
    restart: always
    environment:
      - NODE_ENV=production
      - PORT=9000
      - MEDUSA_WORKER_MODE=server
      # Point to the EXTERNAL Dokploy Database
      - DATABASE_URL=${DATABASE_URL} 
      - REDIS_URL=${REDIS_URL}
      - JWT_SECRET=${JWT_SECRET}
      - COOKIE_SECRET=${COOKIE_SECRET}
    networks:
      - dokploy-network # <--- Join the shared network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.medusa-server.rule=Host(`api.raqueto.shop`)"
      - "traefik.http.routers.medusa-server.entrypoints=websecure"
      - "traefik.http.services.medusa-server.loadbalancer.server.port=9000"

  # 2. Medusa Worker (Background Jobs)
  medusa-worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: medusa_worker
    restart: always
    command: npm run start
    environment:
      - NODE_ENV=production
      - MEDUSA_WORKER_MODE=worker
      - DISABLE_MEDUSA_ADMIN=true
      # Point to the EXTERNAL Dokploy Database
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - JWT_SECRET=${JWT_SECRET}
      - COOKIE_SECRET=${COOKIE_SECRET}
    networks:
      - dokploy-network # <--- Join the shared network

# Define the external network so Compose doesn't try to create it
networks:
  dokploy-network:
    external: true